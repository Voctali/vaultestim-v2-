<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Import vers Supabase - VaultEstim</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      color: #f1f5f9;
      min-height: 100vh;
      padding: 2rem;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    .header {
      text-align: center;
      margin-bottom: 3rem;
    }
    .header h1 {
      font-size: 2.5rem;
      color: #fbbf24;
      margin-bottom: 0.5rem;
    }
    .card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(251, 191, 36, 0.2);
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
    }
    .card h2 {
      color: #fbbf24;
      margin-bottom: 1rem;
      font-size: 1.5rem;
    }
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin: 1.5rem 0;
    }
    .info-item {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.2);
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
    }
    .info-item strong {
      display: block;
      color: #22c55e;
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    button {
      width: 100%;
      padding: 1.5rem;
      font-size: 1.25rem;
      font-weight: bold;
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: #1e293b;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s;
      margin-bottom: 1rem;
    }
    button:hover:not(:disabled) {
      transform: translateY(-2px);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .progress {
      margin: 2rem 0;
      display: none;
    }
    .progress.show {
      display: block;
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #22c55e, #10b981);
      transition: width 0.3s;
      width: 0%;
    }
    .log {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
      max-height: 400px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.9rem;
    }
    .log-item {
      margin: 0.5rem 0;
      padding: 0.25rem 0;
    }
    .success {
      color: #22c55e;
    }
    .error {
      color: #ef4444;
    }
    .warning {
      color: #f59e0b;
    }
    .alert {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
    }
    .auth-section {
      background: rgba(34, 197, 94, 0.05);
      border: 1px solid rgba(34, 197, 94, 0.2);
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 2rem;
    }
    .auth-section input {
      width: 100%;
      padding: 0.75rem;
      margin: 0.5rem 0;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(251, 191, 36, 0.2);
      border-radius: 4px;
      color: #f1f5f9;
      font-size: 1rem;
    }
    #authStatus {
      padding: 1rem;
      border-radius: 4px;
      margin-top: 1rem;
      text-align: center;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üì§ Import Direct vers Supabase</h1>
      <p>Export IndexedDB ‚Üí Import Supabase</p>
    </div>

    <!-- Section Authentification -->
    <div class="card">
      <h2>üîê Connexion Supabase</h2>
      <div class="auth-section">
        <input type="email" id="emailInput" placeholder="Email Supabase" />
        <input type="password" id="passwordInput" placeholder="Mot de passe" />
        <button onclick="loginToSupabase()" id="loginBtn">üîë Se connecter</button>
        <div id="authStatus"></div>
      </div>
    </div>

    <!-- Section Analyse -->
    <div class="card">
      <h2>üìä Donn√©es √† importer</h2>
      <div class="info-grid" id="dataStats">
        <div class="info-item">
          <strong id="cardsCount">?</strong>
          <span>Cartes d√©couvertes</span>
        </div>
        <div class="info-item">
          <strong id="seriesCount">?</strong>
          <span>Extensions</span>
        </div>
        <div class="info-item">
          <strong id="blocksCount">?</strong>
          <span>Blocs personnalis√©s</span>
        </div>
        <div class="info-item">
          <strong id="customExtCount">?</strong>
          <span>Extensions d√©plac√©es</span>
        </div>
      </div>

      <button onclick="analyzeIndexedDB()" id="analyzeBtn">üîç Analyser IndexedDB</button>
      <button onclick="startImport()" id="importBtn" disabled>üì§ Importer vers Supabase</button>
    </div>

    <!-- Section Progression -->
    <div class="progress" id="progress">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="log" id="log"></div>
    </div>

    <!-- Section R√©sultat -->
    <div class="card" id="result" style="display:none;">
      <h2 id="resultTitle">R√©sultat</h2>
      <div id="resultContent"></div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

    const SUPABASE_URL = 'https://ubphwlmnfjdaiarbihcx.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVicGh3bG1uZmpkYWlhcmJpaGN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzgzMzY4NDAsImV4cCI6MjA1MzkxMjg0MH0.Y0YCzMhDrU78A7eDmH3rKGsNSDZSPpU5QGCQH6EtSeg'

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: false // NE PAS utiliser localStorage!
      }
    })

    let currentUser = null
    let indexedDBData = null

    function addLog(message, type = '') {
      const log = document.getElementById('log')
      const logItem = document.createElement('div')
      logItem.className = `log-item ${type}`
      logItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`
      log.appendChild(logItem)
      log.scrollTop = log.scrollHeight
    }

    window.loginToSupabase = async function() {
      const email = document.getElementById('emailInput').value
      const password = document.getElementById('passwordInput').value
      const authStatus = document.getElementById('authStatus')
      const loginBtn = document.getElementById('loginBtn')

      if (!email || !password) {
        authStatus.textContent = '‚ö†Ô∏è Veuillez remplir tous les champs'
        authStatus.style.background = 'rgba(239, 68, 68, 0.1)'
        authStatus.style.color = '#ef4444'
        return
      }

      loginBtn.disabled = true
      authStatus.textContent = 'üîÑ Connexion en cours...'
      authStatus.style.background = 'rgba(59, 130, 246, 0.1)'
      authStatus.style.color = '#3b82f6'

      try {
        const { data, error } = await supabase.auth.signInWithPassword({
          email,
          password
        })

        if (error) throw error

        currentUser = data.user
        authStatus.textContent = `‚úÖ Connect√©: ${currentUser.email}`
        authStatus.style.background = 'rgba(34, 197, 94, 0.1)'
        authStatus.style.color = '#22c55e'

        // Activer le bouton d'analyse
        document.getElementById('analyzeBtn').disabled = false

      } catch (error) {
        console.error('Erreur login:', error)
        authStatus.textContent = `‚ùå Erreur: ${error.message}`
        authStatus.style.background = 'rgba(239, 68, 68, 0.1)'
        authStatus.style.color = '#ef4444'
        loginBtn.disabled = false
      }
    }

    window.analyzeIndexedDB = async function() {
      const analyzeBtn = document.getElementById('analyzeBtn')
      const progress = document.getElementById('progress')
      const log = document.getElementById('log')

      analyzeBtn.disabled = true
      progress.classList.add('show')
      log.innerHTML = ''

      addLog('üîÑ Ouverture de IndexedDB...', 'warning')

      try {
        // Ouvrir IndexedDB
        const db = await openIndexedDB()

        // Charger toutes les donn√©es
        const discoveredCards = await getAllFromStore(db, 'discovered_cards')
        const seriesDatabase = await getAllFromStore(db, 'series_database')
        const customBlocks = await getAllFromStore(db, 'custom_blocks')
        const customExtensions = await getAllFromStore(db, 'custom_extensions')

        indexedDBData = {
          discoveredCards,
          seriesDatabase,
          customBlocks,
          customExtensions
        }

        // Afficher les stats
        document.getElementById('cardsCount').textContent = discoveredCards.length
        document.getElementById('seriesCount').textContent = seriesDatabase.length
        document.getElementById('blocksCount').textContent = customBlocks.length
        document.getElementById('customExtCount').textContent = customExtensions.length

        addLog(`‚úÖ ${discoveredCards.length} cartes trouv√©es`, 'success')
        addLog(`‚úÖ ${seriesDatabase.length} extensions trouv√©es`, 'success')
        addLog(`‚úÖ ${customBlocks.length} blocs personnalis√©s trouv√©s`, 'success')
        addLog(`‚úÖ ${customExtensions.length} extensions d√©plac√©es trouv√©es`, 'success')

        // Activer le bouton d'import
        document.getElementById('importBtn').disabled = false

      } catch (error) {
        console.error('Erreur analyse:', error)
        addLog(`‚ùå Erreur: ${error.message}`, 'error')
        analyzeBtn.disabled = false
      }
    }

    window.startImport = async function() {
      const importBtn = document.getElementById('importBtn')
      const progressFill = document.getElementById('progressFill')
      const result = document.getElementById('result')

      if (!currentUser) {
        addLog('‚ùå Veuillez vous connecter d\'abord', 'error')
        return
      }

      if (!indexedDBData) {
        addLog('‚ùå Veuillez analyser IndexedDB d\'abord', 'error')
        return
      }

      importBtn.disabled = true
      addLog('üöÄ D√©but de l\'import vers Supabase...', 'warning')

      const startTime = Date.now()
      const userId = currentUser.id

      try {
        // √âtape 1: Importer les cartes d√©couvertes (par batch de 500)
        if (indexedDBData.discoveredCards.length > 0) {
          addLog(`üì¶ Import de ${indexedDBData.discoveredCards.length} cartes...`, 'warning')

          const BATCH_SIZE = 500
          const totalCards = indexedDBData.discoveredCards.length

          for (let i = 0; i < totalCards; i += BATCH_SIZE) {
            const batch = indexedDBData.discoveredCards.slice(i, i + BATCH_SIZE)
            const cardsWithUserId = batch.map(card => ({
              ...card,
              user_id: userId
            }))

            const { error } = await supabase
              .from('discovered_cards')
              .upsert(cardsWithUserId, { onConflict: 'id,user_id' })

            if (error) throw error

            const progress = Math.min(100, ((i + BATCH_SIZE) / totalCards) * 25)
            progressFill.style.width = progress + '%'

            addLog(`  ‚úÖ Batch ${Math.floor(i/BATCH_SIZE) + 1}/${Math.ceil(totalCards/BATCH_SIZE)} import√©`, 'success')
          }

          addLog(`‚úÖ ${totalCards} cartes import√©es!`, 'success')
        }

        // √âtape 2: Importer les extensions
        if (indexedDBData.seriesDatabase.length > 0) {
          progressFill.style.width = '50%'
          addLog(`üì¶ Import de ${indexedDBData.seriesDatabase.length} extensions...`, 'warning')

          const seriesWithUserId = indexedDBData.seriesDatabase.map(series => ({
            ...series,
            user_id: userId
          }))

          const { error } = await supabase
            .from('series_database')
            .upsert(seriesWithUserId, { onConflict: 'id,user_id' })

          if (error) throw error

          addLog(`‚úÖ ${indexedDBData.seriesDatabase.length} extensions import√©es!`, 'success')
        }

        // √âtape 3: Importer les blocs personnalis√©s
        if (indexedDBData.customBlocks.length > 0) {
          progressFill.style.width = '75%'
          addLog(`üì¶ Import de ${indexedDBData.customBlocks.length} blocs...`, 'warning')

          const blocksWithUserId = indexedDBData.customBlocks.map(block => ({
            ...block,
            user_id: userId
          }))

          const { error } = await supabase
            .from('custom_blocks')
            .upsert(blocksWithUserId, { onConflict: 'id,user_id' })

          if (error) throw error

          addLog(`‚úÖ ${indexedDBData.customBlocks.length} blocs import√©s!`, 'success')
        }

        // √âtape 4: Importer les extensions d√©plac√©es
        if (indexedDBData.customExtensions.length > 0) {
          progressFill.style.width = '90%'
          addLog(`üì¶ Import de ${indexedDBData.customExtensions.length} extensions d√©plac√©es...`, 'warning')

          const extensionsWithUserId = indexedDBData.customExtensions.map(ext => ({
            ...ext,
            user_id: userId
          }))

          const { error } = await supabase
            .from('custom_extensions')
            .upsert(extensionsWithUserId, { onConflict: 'series_id,user_id' })

          if (error) throw error

          addLog(`‚úÖ ${indexedDBData.customExtensions.length} extensions d√©plac√©es import√©es!`, 'success')
        }

        progressFill.style.width = '100%'

        const duration = Math.round((Date.now() - startTime) / 1000)
        addLog(`üéâ Import termin√© en ${duration}s!`, 'success')

        // Afficher le r√©sultat
        result.style.display = 'block'
        document.getElementById('resultTitle').textContent = 'üéâ Import r√©ussi!'
        document.getElementById('resultContent').innerHTML = `
          <div class="alert" style="background:rgba(34,197,94,0.1);border-color:rgba(34,197,94,0.3);">
            <strong>‚úÖ Toutes vos donn√©es sont maintenant dans Supabase!</strong><br><br>
            <strong>üìä Statistiques:</strong><br>
            ‚Ä¢ ${indexedDBData.discoveredCards.length} cartes import√©es<br>
            ‚Ä¢ ${indexedDBData.seriesDatabase.length} extensions import√©es<br>
            ‚Ä¢ ${indexedDBData.customBlocks.length} blocs personnalis√©s import√©s<br>
            ‚Ä¢ ${indexedDBData.customExtensions.length} extensions d√©plac√©es import√©es<br>
            ‚Ä¢ Dur√©e: ${duration}s<br><br>
            <strong>üéØ Prochaines √©tapes:</strong><br>
            1. Allez sur <a href="/login" style="color:#fbbf24;">http://localhost:5174</a><br>
            2. Nettoyez le localStorage avec <a href="/clean-storage.html" style="color:#fbbf24;">/clean-storage.html</a><br>
            3. Connectez-vous avec vos identifiants Supabase<br>
            4. Vos donn√©es seront synchronis√©es! üöÄ
          </div>
        `

      } catch (error) {
        console.error('Erreur import:', error)
        addLog(`‚ùå Erreur: ${error.message}`, 'error')

        result.style.display = 'block'
        document.getElementById('resultTitle').textContent = '‚ùå Erreur d\'import'
        document.getElementById('resultContent').innerHTML = `
          <div class="alert" style="background:rgba(239,68,68,0.1);border-color:rgba(239,68,68,0.3);">
            <strong>Erreur:</strong> ${error.message}<br><br>
            Vos donn√©es sont toujours dans IndexedDB, vous pouvez r√©essayer.
          </div>
        `

        importBtn.disabled = false
      }
    }

    function openIndexedDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('VaultEstimDB', 3)

        request.onerror = () => reject(request.error)
        request.onsuccess = () => resolve(request.result)
      })
    }

    function getAllFromStore(db, storeName) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(storeName, 'readonly')
        const store = transaction.objectStore(storeName)
        const request = store.getAll()

        request.onerror = () => reject(request.error)
        request.onsuccess = () => resolve(request.result || [])
      })
    }
  </script>
</body>
</html>
