<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Test VaultEstim Database</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .container {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .search-box {
            width: 100%;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 4px;
            background: #333;
            color: white;
            font-size: 16px;
        }
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .card {
            background: #333;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #444;
        }
        .card img {
            width: 100%;
            height: auto;
            border-radius: 4px;
        }
        .card h3 {
            margin: 10px 0 5px 0;
            color: #ffd700;
        }
        .card .price {
            color: #4ade80;
            font-weight: bold;
        }
        .card .set {
            color: #9ca3af;
            font-size: 0.9em;
        }
        .loading {
            text-align: center;
            color: #9ca3af;
        }
        .error {
            color: #ef4444;
            background: #451a1a;
            padding: 10px;
            border-radius: 4px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .stat {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 2em;
            color: #ffd700;
            font-weight: bold;
        }
        .stat-label {
            color: #9ca3af;
            margin-top: 5px;
        }
        button {
            background: #ffd700;
            color: #1a1a1a;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background: #ffed4a;
        }
        .suggestions {
            background: #333;
            border: 1px solid #444;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            position: absolute;
            width: 100%;
            z-index: 100;
        }
        .suggestion {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #444;
        }
        .suggestion:hover {
            background: #444;
        }
        .search-container {
            position: relative;
        }
    </style>
</head>
<body>
    <h1>üéÆ VaultEstim Database Test</h1>

    <!-- Statistiques -->
    <div class="container">
        <h2>üìä Statistiques</h2>
        <div id="stats" class="stats">
            <div class="loading">Chargement des statistiques...</div>
        </div>
    </div>

    <!-- Recherche -->
    <div class="container">
        <h2>üîç Recherche de Cartes</h2>
        <div class="search-container">
            <input
                type="text"
                id="searchInput"
                class="search-box"
                placeholder="Rechercher une carte (ex: Pikachu, Dracaufeu...)"
                autocomplete="off"
            >
            <div id="suggestions" class="suggestions" style="display: none;"></div>
        </div>
        <button onclick="searchCards()">Rechercher</button>
        <button onclick="testSync()">Test Sync</button>

        <div id="results">
            <div class="loading">Tapez un nom de carte pour commencer...</div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        let searchTimeout;

        // Charger les statistiques au d√©marrage
        loadStats();

        // Autocompl√©tion
        document.getElementById('searchInput').addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            const query = e.target.value;

            if (query.length < 2) {
                hideSuggestions();
                return;
            }

            searchTimeout = setTimeout(() => {
                fetchSuggestions(query);
            }, 300);
        });

        // Recherche sur Enter
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchCards();
                hideSuggestions();
            }
        });

        // Charger les statistiques
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                const data = await response.json();

                document.getElementById('stats').innerHTML = `
                    <div class="stat">
                        <div class="stat-value">${data.general.totalSets}</div>
                        <div class="stat-label">Extensions</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${data.general.totalCards}</div>
                        <div class="stat-label">Cartes</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${data.general.cardsWithPrices}</div>
                        <div class="stat-label">Avec Prix</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${data.general.pricesCoverage}%</div>
                        <div class="stat-label">Couverture Prix</div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('stats').innerHTML = `
                    <div class="error">‚ùå Erreur chargement stats: ${error.message}</div>
                `;
            }
        }

        // Autocompl√©tion
        async function fetchSuggestions(query) {
            try {
                const response = await fetch(`${API_BASE}/cards/autocomplete?q=${encodeURIComponent(query)}`);
                const data = await response.json();

                const suggestionsDiv = document.getElementById('suggestions');

                if (data.suggestions && data.suggestions.length > 0) {
                    suggestionsDiv.innerHTML = data.suggestions.map(suggestion => `
                        <div class="suggestion" onclick="selectSuggestion('${suggestion.name}')">
                            ${suggestion.image ? `<img src="${suggestion.image}" style="width: 20px; height: 28px; float: left; margin-right: 10px;">` : ''}
                            <strong>${suggestion.name}</strong>
                            ${suggestion.name_fr && suggestion.name_fr !== suggestion.name ? `<br><small>${suggestion.name_fr}</small>` : ''}
                        </div>
                    `).join('');
                    suggestionsDiv.style.display = 'block';
                } else {
                    hideSuggestions();
                }
            } catch (error) {
                console.error('Erreur autocompl√©tion:', error);
                hideSuggestions();
            }
        }

        function selectSuggestion(name) {
            document.getElementById('searchInput').value = name;
            hideSuggestions();
            searchCards();
        }

        function hideSuggestions() {
            document.getElementById('suggestions').style.display = 'none';
        }

        // Recherche de cartes
        async function searchCards() {
            const query = document.getElementById('searchInput').value;
            const resultsDiv = document.getElementById('results');

            if (!query) {
                resultsDiv.innerHTML = '<div class="loading">Veuillez entrer un terme de recherche</div>';
                return;
            }

            resultsDiv.innerHTML = '<div class="loading">üîç Recherche en cours...</div>';

            try {
                const response = await fetch(`${API_BASE}/cards?q=${encodeURIComponent(query)}&limit=20`);
                const data = await response.json();

                if (data.data && data.data.length > 0) {
                    resultsDiv.innerHTML = `
                        <div style="margin: 20px 0; color: #9ca3af;">
                            ${data.data.length} cartes trouv√©es (page ${data.pagination.page}/${data.pagination.totalPages})
                        </div>
                        <div class="cards-grid">
                            ${data.data.map(card => `
                                <div class="card">
                                    ${card.images && card.images.small ?
                                        `<img src="${card.images.small}" alt="${card.name}" onerror="this.src='/placeholder-card.jpg'">` :
                                        '<div style="background: #444; height: 150px; display: flex; align-items: center; justify-content: center; border-radius: 4px;">Pas d\'image</div>'
                                    }
                                    <h3>${card.name}</h3>
                                    ${card.name_fr && card.name_fr !== card.name ? `<div style="color: #9ca3af; font-size: 0.9em;">${card.name_fr}</div>` : ''}
                                    <div class="set">${card.set ? card.set.name : 'Extension inconnue'} #${card.number || '?'}</div>
                                    <div class="price">${card.price && card.price.market > 0 ? `${card.price.market}${card.price.currency === 'EUR' ? '‚Ç¨' : '$'}` : 'Prix N/A'}</div>
                                    ${card.rarity ? `<div style="color: #fbbf24; font-size: 0.8em;">${card.rarity}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = '<div class="error">‚ùå Aucune carte trouv√©e</div>';
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            }
        }

        // Test de synchronisation
        async function testSync() {
            try {
                document.getElementById('results').innerHTML = '<div class="loading">üîÑ Test de synchronisation...</div>';

                const response = await fetch(`${API_BASE}/sync/status`);
                const data = await response.json();

                document.getElementById('results').innerHTML = `
                    <div class="container">
                        <h3>üìä Statut Synchronisation</h3>
                        <p><strong>En cours:</strong> ${data.isRunning ? '‚úÖ Oui' : '‚ùå Non'}</p>
                        <p><strong>Derni√®re sync:</strong> ${data.lastSync ? new Date(data.lastSync).toLocaleString() : 'Jamais'}</p>
                        <p><strong>Statistiques:</strong></p>
                        <pre>${JSON.stringify(data.stats, null, 2)}</pre>
                        <button onclick="triggerSync()">D√©clencher Sync</button>
                    </div>
                `;
            } catch (error) {
                document.getElementById('results').innerHTML = `<div class="error">‚ùå Erreur sync: ${error.message}</div>`;
            }
        }

        // D√©clencher synchronisation
        async function triggerSync() {
            try {
                const response = await fetch(`${API_BASE}/sync/full`, { method: 'POST' });
                const data = await response.json();

                alert('‚úÖ ' + data.message);

                // Recharger le statut apr√®s 2 secondes
                setTimeout(testSync, 2000);
            } catch (error) {
                alert('‚ùå Erreur: ' + error.message);
            }
        }

        // Tests automatiques au chargement
        window.addEventListener('load', function() {
            // Test de connectivit√© API
            fetch(`${API_BASE}/health`)
                .then(response => response.json())
                .then(data => {
                    console.log('‚úÖ API connect√©e:', data);
                })
                .catch(error => {
                    document.body.insertAdjacentHTML('afterbegin', `
                        <div class="error" style="margin-bottom: 20px;">
                            ‚ùå API non disponible (${error.message}).
                            Assurez-vous que le serveur est d√©marr√©: <code>npm run dev</code>
                        </div>
                    `);
                });
        });

        // Cacher suggestions en cliquant ailleurs
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container')) {
                hideSuggestions();
            }
        });
    </script>
</body>
</html>